from odoo.tests import SavepointCase
from odoo.exceptions import ValidationError

class TestHospitalModule(SavepointCase):

    @classmethod
    def setUpClass(cls):
        super(TestHospitalModule, cls).setUpClass()
        cls.Patient = cls.env['hospital.patient']
        cls.Doctor = cls.env['hospital.doctor']
        cls.Appointment = cls.env['hospital.appointment']

        cls.doctor = cls.Doctor.create({
            'doctor_name': 'Dr. Strange',
            'gender': 'male',
            'age': 45,
        })

    def test_patient_defaults(self):
        """Test that patient defaults (reference and note) are set if not given."""
        patient = self.Patient.create({'name': 'Test Patient', 'age': 30})
        self.assertNotEqual(patient.reference, 'New', "Patient reference should be generated by a sequence.")
        print("PASS: Patient reference is not 'New'.")

        self.assertEqual(patient.note, 'New Patient', "Default note should be set if none provided.")
        print("PASS: Patient note defaulted correctly.")

    def test_patient_unique_name_constraint(self):
        """Test that creating two patients with the same name raises a ValidationError."""
        self.Patient.create({'name': 'UniqueName', 'age': 20})
        print("PASS: First patient with name 'UniqueName' created successfully.")
        try:
            self.Patient.create({'name': 'UniqueName', 'age': 22})
            # If we reach this line, no ValidationError was raised.
            print("FAIL: Duplicate name was allowed, which should not happen.")
        except ValidationError:
            print("PASS: ValidationError raised as expected for duplicate patient name.")

    def test_patient_age_constraint(self):
        """Test that patient age cannot be zero."""
        try:
            self.Patient.create({'name': 'No Age Patient', 'age': 0})
            print("FAIL: Patient with age=0 created without ValidationError.")
        except ValidationError:
            print("PASS: ValidationError raised for zero age as expected.")

    def test_appointment_cannot_delete_done(self):
        """Test that you cannot delete appointments in 'done' state."""
        patient = self.Patient.create({'name': 'Deletable Patient', 'age': 25})
        appointment = self.Appointment.create({
            'patient_id': patient.id,
            'doctor_id': self.doctor.id,
        })
        appointment.action_confirm()
        appointment.action_done()
        try:
            appointment.unlink()
            print("FAIL: Deleted a 'done' appointment, which should not be possible.")
        except ValidationError:
            print("PASS: ValidationError raised as expected for deleting 'done' appointment.")

        # Ensure that if appointment is in draft, it can be deleted
        appointment2 = self.Appointment.create({
            'patient_id': patient.id,
            'doctor_id': self.doctor.id,
        })
        appointment2.unlink()
        print("PASS: Draft appointment deleted successfully.")
